<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Check-In | Ghana Competition Law & Policy Seminar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .pulse { animation: pulse 2s infinite; }
        #reader { width: 100%; }
        #reader video { border-radius: 12px; width: 100% !important; }
        #reader__scan_region { min-height: 280px; }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mobile-scanner-fullwidth { margin: -1rem; margin-top: 0; width: calc(100% + 2rem); border-radius: 0; }
            .mobile-hide { display: none !important; }
            .mobile-stack { flex-direction: column; }
            .mobile-full { width: 100%; }
            .mobile-text-sm { font-size: 0.875rem; }
            .mobile-p-3 { padding: 0.75rem; }
            .mobile-gap-2 { gap: 0.5rem; }
        }
        
        /* PIN input styles */
        .pin-input {
            width: 3rem;
            height: 3.5rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            background: #f8fafc;
            transition: all 0.2s;
        }
        .pin-input:focus {
            outline: none;
            border-color: #10b981;
            background: white;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        
        /* Bottom sheet for mobile */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 1.5rem 1.5rem 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 40;
            max-height: 70vh;
            overflow-y: auto;
        }
        .bottom-sheet.active { transform: translateY(0); }
        .bottom-sheet-handle {
            width: 40px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 8px auto 16px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- PIN Entry Screen -->
    <div id="pinScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <h1 class="text-xl font-bold text-slate-800 mb-2">Staff Access</h1>
            <p class="text-slate-500 text-sm mb-6">Enter the 4-digit staff PIN to access check-in</p>
            
            <div id="pinContainer" class="flex justify-center gap-3 mb-6">
                <input type="tel" maxlength="1" class="pin-input" data-index="0" inputmode="numeric" pattern="[0-9]*">
                <input type="tel" maxlength="1" class="pin-input" data-index="1" inputmode="numeric" pattern="[0-9]*">
                <input type="tel" maxlength="1" class="pin-input" data-index="2" inputmode="numeric" pattern="[0-9]*">
                <input type="tel" maxlength="1" class="pin-input" data-index="3" inputmode="numeric" pattern="[0-9]*">
            </div>
            
            <p id="pinError" class="text-red-500 text-sm mb-4 hidden">Incorrect PIN. Please try again.</p>
            
            <button id="verifyPinBtn" class="w-full bg-emerald-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Access Check-In
            </button>
        </div>
    </div>

    <!-- Main Check-In Content (hidden until PIN verified) -->
    <div id="mainContent" class="hidden">
    <!-- Header - Mobile Optimized -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-3 py-3 md:px-4 md:py-4 flex items-center justify-between">
            <div class="flex items-center gap-2 md:gap-3">
                <img src="https://ik.imagekit.io/dr5fryhth/conference/imglogo?updatedAt=1769778325875" alt="Logo" class="h-8 md:h-10">
                <div>
                    <h1 class="font-bold text-slate-900 text-sm md:text-base">Check-In</h1>
                    <p class="text-xs text-slate-500 hidden md:block">Ghana Competition Law & Policy Seminar</p>
                </div>
            </div>
            <div class="flex items-center gap-3 md:gap-4">
                <div class="text-center md:text-right">
                    <p class="text-xl md:text-2xl font-bold text-slate-900" id="checkedInCount">0</p>
                    <p class="text-xs text-slate-500">In</p>
                </div>
                <div class="w-px h-8 md:h-10 bg-slate-200"></div>
                <div class="text-center md:text-right">
                    <p class="text-xl md:text-2xl font-bold text-emerald-600" id="totalCount">0</p>
                    <p class="text-xs text-slate-500">Total</p>
                </div>
                <button onclick="toggleAttendeeList()" class="md:hidden p-2 bg-slate-100 rounded-lg">
                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-3 py-4 md:px-4 md:py-6">
        <div class="grid lg:grid-cols-3 gap-4 md:gap-6">
            <!-- Scanner Section - Mobile First -->
            <div class="lg:col-span-1 space-y-4 md:space-y-6">
                <!-- QR Scanner - Full width on mobile -->
                <div class="bg-white rounded-2xl border border-slate-200 p-4 md:p-6 shadow-sm">
                    <!-- Scanner Status & Controls -->
                    <div id="scannerControls" class="text-center">
                        <div id="scannerPlaceholder" class="py-8">
                            <div class="w-20 h-20 mx-auto mb-4 bg-emerald-100 rounded-full flex items-center justify-center">
                                <svg class="w-10 h-10 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                                </svg>
                            </div>
                            <p class="text-slate-600 font-medium mb-2">Scan QR Code</p>
                            <p class="text-slate-400 text-sm mb-4">Tap the button below to start camera</p>
                            <button id="toggleScanner" class="w-full py-4 bg-emerald-600 text-white rounded-xl font-semibold text-lg hover:bg-emerald-700 transition-colors flex items-center justify-center gap-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span id="scannerBtnText">Start Scanner</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Camera View -->
                    <div id="reader" class="rounded-xl overflow-hidden bg-slate-900 hidden"></div>
                    
                    <!-- Stop Scanner Button (shown when scanning) -->
                    <button id="stopScannerBtn" class="hidden w-full mt-4 py-3 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors">
                        Stop Scanner
                    </button>
                    
                    <!-- Permission Error Message -->
                    <div id="permissionError" class="hidden text-center py-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <p class="text-red-600 font-medium mb-2">Camera Access Required</p>
                        <p class="text-slate-500 text-sm mb-4">Please allow camera access to scan QR codes</p>
                        <div class="text-left bg-slate-50 rounded-xl p-4 text-sm text-slate-600 space-y-2">
                            <p class="font-medium">How to enable:</p>
                            <ol class="list-decimal list-inside space-y-1 text-xs">
                                <li>Tap the lock/info icon in browser address bar</li>
                                <li>Find "Camera" permission</li>
                                <li>Change to "Allow"</li>
                                <li>Refresh the page</li>
                            </ol>
                        </div>
                        <button onclick="retryCamera()" class="mt-4 w-full py-3 bg-slate-900 text-white rounded-xl font-medium">
                            Try Again
                        </button>
                    </div>
                </div>

                <!-- Manual Entry - Compact on mobile -->
                <div class="bg-white rounded-2xl border border-slate-200 p-4 md:p-6 shadow-sm">
                    <h2 class="font-semibold text-slate-900 mb-3 text-sm md:text-base">Or Enter Code Manually</h2>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="ticketCodeInput" 
                            placeholder="Ticket code"
                            class="flex-1 px-3 py-3 border border-slate-200 rounded-xl text-base focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent uppercase"
                            onkeydown="if(event.key === 'Enter') verifyTicket()"
                            autocomplete="off"
                            autocapitalize="characters"
                        >
                        <button 
                            onclick="verifyTicket()"
                            class="px-5 py-3 bg-slate-900 text-white rounded-xl text-sm font-medium hover:bg-slate-800 transition-colors"
                        >
                            Go
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right: Attendance List - Hidden on mobile, shown in bottom sheet -->
            <div class="lg:col-span-2 hidden md:block">
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm">
                    <div class="p-4 md:p-6 border-b border-slate-100">
                        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                            <h2 class="font-semibold text-slate-900">Attendance</h2>
                            <div class="flex gap-1 md:gap-2">
                                <button onclick="filterAttendance('all')" class="filter-btn px-2 md:px-3 py-1.5 text-xs md:text-sm rounded-lg bg-slate-900 text-white" data-filter="all">All</button>
                                <button onclick="filterAttendance('checked')" class="filter-btn px-2 md:px-3 py-1.5 text-xs md:text-sm rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200" data-filter="checked">In</button>
                                <button onclick="filterAttendance('pending')" class="filter-btn px-2 md:px-3 py-1.5 text-xs md:text-sm rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200" data-filter="pending">Pending</button>
                            </div>
                        </div>
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search..."
                            class="w-full px-3 py-2.5 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                            oninput="searchAttendees()"
                        >
                    </div>
                    <div class="max-h-[600px] overflow-y-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50 sticky top-0">
                                <tr>
                                    <th class="px-3 md:px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Attendee</th>
                                    <th class="px-3 md:px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase hidden md:table-cell">Ticket</th>
                                    <th class="px-3 md:px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Status</th>
                                    <th class="px-3 md:px-6 py-3 text-right text-xs font-semibold text-slate-500 uppercase">Action</th>
                                </tr>
                            </thead>
                            <tbody id="attendeesList" class="divide-y divide-slate-100">
                                <!-- Will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Bottom Sheet for Attendee List -->
    <div id="attendeeSheet" class="bottom-sheet md:hidden">
        <div class="bottom-sheet-handle"></div>
        <div class="px-4 pb-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold text-slate-900">Attendees</h2>
                <button onclick="toggleAttendeeList()" class="p-2 text-slate-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="flex gap-2 mb-3">
                <button onclick="filterAttendance('all')" class="filter-btn-mobile flex-1 py-2 text-xs rounded-lg bg-slate-900 text-white" data-filter="all">All</button>
                <button onclick="filterAttendance('checked')" class="filter-btn-mobile flex-1 py-2 text-xs rounded-lg bg-slate-100 text-slate-600" data-filter="checked">Checked In</button>
                <button onclick="filterAttendance('pending')" class="filter-btn-mobile flex-1 py-2 text-xs rounded-lg bg-slate-100 text-slate-600" data-filter="pending">Pending</button>
            </div>
            <input 
                type="text" 
                id="searchInputMobile" 
                placeholder="Search attendees..."
                class="w-full px-3 py-2.5 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 mb-3"
                oninput="searchAttendees()"
            >
            <div id="attendeesListMobile" class="space-y-2 max-h-[50vh] overflow-y-auto">
                <!-- Mobile attendee cards -->
            </div>
        </div>
    </div>
    <div id="sheetOverlay" class="fixed inset-0 bg-black/30 hidden z-30 md:hidden" onclick="toggleAttendeeList()"></div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 text-center slide-in">
            <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-slate-900 mb-2" id="modalName">John Doe</h3>
            <p class="text-slate-500 mb-1" id="modalOrg">Law Firm Name</p>
            <p class="text-sm text-emerald-600 font-medium mb-6" id="modalTicket">GCL-ABC123</p>
            <p class="text-lg font-semibold text-emerald-600 mb-6">✓ Checked In Successfully</p>
            <button onclick="closeModal()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-medium hover:bg-slate-800">
                Continue
            </button>
        </div>
    </div>

    <!-- Already Checked In Modal -->
    <div id="alreadyCheckedModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 text-center slide-in">
            <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-slate-900 mb-2" id="alreadyModalName">John Doe</h3>
            <p class="text-slate-500 mb-1" id="alreadyModalOrg">Law Firm Name</p>
            <p class="text-sm text-slate-600 font-medium mb-2" id="alreadyModalTicket">GCL-ABC123</p>
            <p class="text-amber-600 font-semibold mb-2">Already Checked In</p>
            <p class="text-sm text-slate-500 mb-6" id="alreadyModalTime">at 10:30 AM</p>
            <button onclick="closeAlreadyModal()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-medium hover:bg-slate-800">
                OK
            </button>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 text-center slide-in">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-slate-900 mb-2">Invalid Ticket</h3>
            <p class="text-slate-500 mb-6" id="errorMessage">Ticket not found or not confirmed</p>
            <button onclick="closeErrorModal()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-medium hover:bg-slate-800">
                Try Again
            </button>
        </div>
    </div>
    </div> <!-- End mainContent -->

    <script>
        let html5QrCode = null;
        let isScanning = false;
        let allTickets = [];
        let currentFilter = 'all';
        let isSheetOpen = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchStats();
            fetchTickets();
            setInterval(fetchStats, 10000);
            
            // Setup scanner button
            document.getElementById('toggleScanner').addEventListener('click', toggleScanner);
            document.getElementById('stopScannerBtn').addEventListener('click', stopScanner);
        });

        async function fetchStats() {
            try {
                const res = await fetch('/api/tickets/checkins/stats');
                const data = await res.json();
                document.getElementById('checkedInCount').textContent = data.checked_in;
                document.getElementById('totalCount').textContent = data.total_tickets;
            } catch (err) {
                console.error('Failed to fetch stats:', err);
            }
        }

        async function fetchTickets() {
            try {
                const res = await fetch('/api/tickets');
                const data = await res.json();
                allTickets = data.tickets || [];
                renderAttendees();
            } catch (err) {
                console.error('Failed to fetch tickets:', err);
            }
        }

        function renderAttendees() {
            const searchDesktop = document.getElementById('searchInput');
            const searchMobile = document.getElementById('searchInputMobile');
            const search = (searchDesktop?.value || searchMobile?.value || '').toLowerCase();
            let filtered = allTickets;

            if (currentFilter === 'checked') {
                filtered = filtered.filter(t => t.checked_in);
            } else if (currentFilter === 'pending') {
                filtered = filtered.filter(t => !t.checked_in);
            }

            if (search) {
                filtered = filtered.filter(t => 
                    t.full_name.toLowerCase().includes(search) ||
                    t.email.toLowerCase().includes(search) ||
                    t.ticket_code.toLowerCase().includes(search) ||
                    (t.firm_name && t.firm_name.toLowerCase().includes(search))
                );
            }

            // Desktop table
            const tbody = document.getElementById('attendeesList');
            if (tbody) {
                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">No attendees found</td></tr>';
                } else {
                    tbody.innerHTML = filtered.map(t => `
                        <tr class="hover:bg-slate-50 ${t.checked_in ? 'bg-emerald-50/30' : ''}">
                            <td class="px-3 md:px-6 py-3 md:py-4">
                                <div>
                                    <p class="font-medium text-slate-900 text-sm md:text-base">${escapeHtml(t.full_name)}</p>
                                    <p class="text-xs md:text-sm text-slate-500">${escapeHtml(t.firm_name || t.email)}</p>
                                </div>
                            </td>
                            <td class="px-3 md:px-6 py-3 md:py-4 hidden md:table-cell">
                                <span class="font-mono text-sm text-slate-600">${t.ticket_code}</span>
                            </td>
                            <td class="px-3 md:px-6 py-3 md:py-4">
                                ${t.checked_in 
                                    ? `<span class="inline-flex items-center gap-1 text-emerald-600 text-xs md:text-sm font-medium">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                        In
                                       </span>`
                                    : '<span class="text-slate-400 text-xs md:text-sm">—</span>'
                                }
                            </td>
                            <td class="px-3 md:px-6 py-3 md:py-4 text-right">
                                ${!t.checked_in 
                                    ? `<button onclick="checkInByCode('${t.ticket_code}')" class="px-3 md:px-4 py-1.5 md:py-2 bg-emerald-600 text-white text-xs md:text-sm rounded-lg hover:bg-emerald-700 transition-colors">Check In</button>`
                                    : ''
                                }
                            </td>
                        </tr>
                    `).join('');
                }
            }

            // Mobile cards
            const mobileList = document.getElementById('attendeesListMobile');
            if (mobileList) {
                if (filtered.length === 0) {
                    mobileList.innerHTML = '<p class="text-center text-slate-400 py-8">No attendees found</p>';
                } else {
                    mobileList.innerHTML = filtered.map(t => `
                        <div class="bg-slate-50 rounded-xl p-3 ${t.checked_in ? 'border-l-4 border-emerald-500' : ''}">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-slate-900 text-sm truncate">${escapeHtml(t.full_name)}</p>
                                    <p class="text-xs text-slate-500 truncate">${escapeHtml(t.firm_name || '')}</p>
                                    <p class="text-xs text-slate-400 font-mono mt-1">${t.ticket_code}</p>
                                </div>
                                <div class="ml-3 flex-shrink-0">
                                    ${t.checked_in 
                                        ? `<span class="inline-flex items-center gap-1 text-emerald-600 text-xs font-medium bg-emerald-100 px-2 py-1 rounded-full">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                            In
                                           </span>`
                                        : `<button onclick="checkInByCode('${t.ticket_code}')" class="px-3 py-1.5 bg-emerald-600 text-white text-xs rounded-lg">Check In</button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        function filterAttendance(filter) {
            currentFilter = filter;
            // Desktop buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.className = 'filter-btn px-2 md:px-3 py-1.5 text-xs md:text-sm rounded-lg bg-slate-900 text-white';
                } else {
                    btn.className = 'filter-btn px-2 md:px-3 py-1.5 text-xs md:text-sm rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200';
                }
            });
            // Mobile buttons
            document.querySelectorAll('.filter-btn-mobile').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.className = 'filter-btn-mobile flex-1 py-2 text-xs rounded-lg bg-slate-900 text-white';
                } else {
                    btn.className = 'filter-btn-mobile flex-1 py-2 text-xs rounded-lg bg-slate-100 text-slate-600';
                }
            });
            renderAttendees();
        }

        function searchAttendees() {
            renderAttendees();
        }

        function toggleAttendeeList() {
            const sheet = document.getElementById('attendeeSheet');
            const overlay = document.getElementById('sheetOverlay');
            isSheetOpen = !isSheetOpen;
            
            if (isSheetOpen) {
                sheet.classList.add('active');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                sheet.classList.remove('active');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        // QR Scanner with better permission handling
        async function toggleScanner() {
            if (isScanning) {
                await stopScanner();
                return;
            }
            
            const placeholder = document.getElementById('scannerPlaceholder');
            const reader = document.getElementById('reader');
            const stopBtn = document.getElementById('stopScannerBtn');
            const permError = document.getElementById('permissionError');
            
            // Hide placeholder, show reader
            placeholder.classList.add('hidden');
            permError.classList.add('hidden');
            reader.classList.remove('hidden');
            
            html5QrCode = new Html5Qrcode("reader");
            
            try {
                // Calculate QR box size based on screen
                const qrboxSize = Math.min(window.innerWidth - 80, 250);
                
                // Start the QR scanner directly - let the library handle camera access
                await html5QrCode.start(
                    { facingMode: "environment" },
                    { 
                        fps: 10, 
                        qrbox: { width: qrboxSize, height: qrboxSize },
                        aspectRatio: 1.0
                    },
                    onScanSuccess,
                    onScanFailure
                );
                isScanning = true;
                stopBtn.classList.remove('hidden');
                
            } catch (err) {
                console.error('Camera error:', err);
                reader.classList.add('hidden');
                stopBtn.classList.add('hidden');
                permError.classList.remove('hidden');
                
                // Show appropriate error message
                const errorTitle = permError.querySelector('p.text-red-600');
                const errorDesc = permError.querySelector('p.text-slate-500');
                const errorHelp = permError.querySelector('.text-left');
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError' || 
                    (err.message && err.message.includes('Permission'))) {
                    errorTitle.textContent = 'Camera Permission Denied';
                    errorDesc.textContent = 'Please allow camera access in your browser settings';
                    errorHelp.innerHTML = `
                        <p class="font-medium">How to enable:</p>
                        <ol class="list-decimal list-inside space-y-1 text-xs mt-2">
                            <li>Tap the lock/settings icon in the address bar</li>
                            <li>Find "Camera" and set to "Allow"</li>
                            <li>Refresh the page and try again</li>
                        </ol>
                    `;
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError' ||
                           (err.message && err.message.includes('not found'))) {
                    errorTitle.textContent = 'No Camera Found';
                    errorDesc.textContent = 'This device does not have a camera or it is in use';
                    errorHelp.innerHTML = `<p class="text-xs">Try closing other apps that might be using the camera.</p>`;
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errorTitle.textContent = 'Camera In Use';
                    errorDesc.textContent = 'The camera is being used by another application';
                    errorHelp.innerHTML = `<p class="text-xs">Close other apps using the camera and try again.</p>`;
                } else if (err.name === 'OverconstrainedError') {
                    errorTitle.textContent = 'Camera Error';
                    errorDesc.textContent = 'Could not find a suitable camera';
                    errorHelp.innerHTML = `<p class="text-xs">Try using a different browser.</p>`;
                } else {
                    errorTitle.textContent = 'Camera Error';
                    errorDesc.textContent = err.message || 'Could not start camera';
                    errorHelp.innerHTML = `
                        <p class="text-xs">Error details: ${err.name || 'Unknown'}</p>
                        <p class="text-xs mt-1">Try refreshing the page or using a different browser.</p>
                    `;
                }
            }
        }

        async function stopScanner() {
            if (html5QrCode && isScanning) {
                await html5QrCode.stop();
            }
            isScanning = false;
            
            document.getElementById('reader').classList.add('hidden');
            document.getElementById('stopScannerBtn').classList.add('hidden');
            document.getElementById('scannerPlaceholder').classList.remove('hidden');
            document.getElementById('permissionError').classList.add('hidden');
        }

        function retryCamera() {
            document.getElementById('permissionError').classList.add('hidden');
            document.getElementById('scannerPlaceholder').classList.remove('hidden');
            toggleScanner();
        }

        function onScanSuccess(decodedText) {
            // Pause scanning while processing
            if (html5QrCode) {
                html5QrCode.pause();
            }
            
            // Try to parse as JSON (QR data format)
            let ticketCode = decodedText;
            try {
                const qrData = JSON.parse(decodedText);
                ticketCode = qrData.ticketCode || decodedText;
            } catch (e) {
                // Not JSON, use as-is
            }
            
            checkInByCode(ticketCode);
        }

        function onScanFailure(error) {
            // Ignore scan failures (no QR in frame)
        }

        async function verifyTicket() {
            const code = document.getElementById('ticketCodeInput').value.trim();
            if (!code) return;
            
            await checkInByCode(code);
            document.getElementById('ticketCodeInput').value = '';
        }

        async function checkInByCode(ticketCode) {
            try {
                const res = await fetch('/api/tickets/checkin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticket_code: ticketCode })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    if (data.success) {
                        // Get ticket details for modal
                        const ticketRes = await fetch(`/api/tickets/${ticketCode}`);
                        const ticketData = await ticketRes.json();
                        
                        showSuccessModal(ticketData);
                        fetchStats();
                        fetchTickets();
                    } else {
                        // Already checked in
                        const ticketRes = await fetch(`/api/tickets/${ticketCode}`);
                        const ticketData = await ticketRes.json();
                        showAlreadyCheckedModal(ticketData, data.checked_in_at);
                    }
                } else {
                    showErrorModal(data.detail || 'Ticket not found');
                }
            } catch (err) {
                console.error('Check-in error:', err);
                showErrorModal('Failed to process check-in');
            }
            
            // Resume scanner
            if (html5QrCode && isScanning) {
                setTimeout(() => html5QrCode.resume(), 2000);
            }
        }

        function showSuccessModal(ticket) {
            document.getElementById('modalName').textContent = ticket.full_name;
            document.getElementById('modalOrg').textContent = ticket.firm_name || ticket.email;
            document.getElementById('modalTicket').textContent = ticket.ticket_code;
            document.getElementById('successModal').classList.remove('hidden');
            document.getElementById('successModal').classList.add('flex');
            
            // Play success sound
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp2ZlI2Ff3Z1eYGKkpWTjYV9dnR3f4mTmZqXkYqCe3d2eYCJkZaXlZCJgXt3dnh/iJCVlpSPiIF7d3d5gIiQlZaUj4iBe3d3eYCIkJWWlI+IgXt3d3mAiJCVlpSPiIF7d3d5gIiQlZaUj4iBe3d3eYCIkJWWlI+IgXt3d3mAiJCVlpSPiIF7d3d5gIiQlZaUj4iBe3d3eYCIkJWWlI+IgQ==');
                audio.play();
            } catch (e) {}
        }

        function showAlreadyCheckedModal(ticket, checkedInAt) {
            document.getElementById('alreadyModalName').textContent = ticket.full_name;
            document.getElementById('alreadyModalOrg').textContent = ticket.firm_name || ticket.email;
            document.getElementById('alreadyModalTicket').textContent = ticket.ticket_code;
            document.getElementById('alreadyModalTime').textContent = 'at ' + formatTime(checkedInAt);
            document.getElementById('alreadyCheckedModal').classList.remove('hidden');
            document.getElementById('alreadyCheckedModal').classList.add('flex');
        }

        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
            document.getElementById('errorModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
        }

        function closeAlreadyModal() {
            document.getElementById('alreadyCheckedModal').classList.add('hidden');
            document.getElementById('alreadyCheckedModal').classList.remove('flex');
        }

        function closeErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
            document.getElementById('errorModal').classList.remove('flex');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        // Keyboard shortcut
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeAlreadyModal();
                closeErrorModal();
            }
        });
    </script>

    <!-- PIN Verification Script -->
    <script>
        const STAFF_PIN = '2003';
        const pinInputs = document.querySelectorAll('.pin-input');
        const verifyPinBtn = document.getElementById('verifyPinBtn');
        const pinError = document.getElementById('pinError');
        const pinContainer = document.getElementById('pinContainer');
        const pinScreen = document.getElementById('pinScreen');
        const mainContent = document.getElementById('mainContent');
        
        // Check if already authenticated in this session
        if (sessionStorage.getItem('checkinAuth') === 'true') {
            pinScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
        }
        
        pinInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value.replace(/[^0-9]/g, '');
                e.target.value = value;
                
                if (value && index < pinInputs.length - 1) {
                    pinInputs[index + 1].focus();
                }
                
                checkPinComplete();
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    pinInputs[index - 1].focus();
                }
                if (e.key === 'Enter' && !verifyPinBtn.disabled) {
                    verifyPinBtn.click();
                }
            });
            
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                const digits = paste.replace(/[^0-9]/g, '').slice(0, 4);
                
                digits.split('').forEach((digit, i) => {
                    if (pinInputs[i]) {
                        pinInputs[i].value = digit;
                    }
                });
                
                checkPinComplete();
            });
        });
        
        function checkPinComplete() {
            const pin = Array.from(pinInputs).map(i => i.value).join('');
            verifyPinBtn.disabled = pin.length !== 4;
        }
        
        function getEnteredPin() {
            return Array.from(pinInputs).map(i => i.value).join('');
        }
        
        verifyPinBtn.addEventListener('click', () => {
            const enteredPin = getEnteredPin();
            
            if (enteredPin !== STAFF_PIN) {
                pinError.classList.remove('hidden');
                pinContainer.classList.add('shake');
                setTimeout(() => pinContainer.classList.remove('shake'), 500);
                
                pinInputs.forEach(input => input.value = '');
                pinInputs[0].focus();
                verifyPinBtn.disabled = true;
                return;
            }
            
            // PIN correct - show main content
            pinError.classList.add('hidden');
            sessionStorage.setItem('checkinAuth', 'true');
            pinScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
        });
        
        // Auto-focus first input
        if (!sessionStorage.getItem('checkinAuth')) {
            pinInputs[0].focus();
        }
    </script>
</body>
</html>
