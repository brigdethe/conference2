<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Verify Ticket - CMC Conference</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .pin-input {
            width: 3rem;
            height: 3.5rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            background: #f8fafc;
            transition: all 0.2s;
        }
        .pin-input:focus {
            outline: none;
            border-color: #10b981;
            background: white;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <!-- PIN Entry Screen -->
    <div id="pinScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <h1 class="text-xl font-bold text-slate-800 mb-2">Staff Verification</h1>
            <p class="text-slate-500 text-sm mb-6">Enter the 4-digit staff PIN to verify this ticket</p>
            
            <div id="pinContainer" class="flex justify-center gap-3 mb-6">
                <input type="tel" maxlength="1" class="pin-input" data-index="0" inputmode="numeric" pattern="[0-9]*">
                <input type="tel" maxlength="1" class="pin-input" data-index="1" inputmode="numeric" pattern="[0-9]*">
                <input type="tel" maxlength="1" class="pin-input" data-index="2" inputmode="numeric" pattern="[0-9]*">
                <input type="tel" maxlength="1" class="pin-input" data-index="3" inputmode="numeric" pattern="[0-9]*">
            </div>
            
            <p id="pinError" class="text-red-500 text-sm mb-4 hidden">Incorrect PIN. Please try again.</p>
            
            <button id="verifyPinBtn" class="w-full bg-emerald-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-emerald-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Verify
            </button>
        </div>
    </div>

    <!-- Verification Result Screen (hidden initially) -->
    <div id="resultScreen" class="min-h-screen p-4 hidden">
        <div class="max-w-md mx-auto">
            <!-- Status Card -->
            <div id="statusCard" class="bg-white rounded-2xl shadow-xl overflow-hidden mb-4">
                <!-- Status Header -->
                <div id="statusHeader" class="p-6 text-center">
                    <div id="statusIcon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"></div>
                    <h2 id="statusTitle" class="text-2xl font-bold mb-1"></h2>
                    <p id="statusMessage" class="text-sm"></p>
                </div>
                
                <!-- Ticket Details -->
                <div id="ticketDetails" class="border-t border-slate-100 p-6 hidden">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 text-sm">Name</span>
                            <span id="attendeeName" class="font-semibold text-slate-800"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 text-sm">Email</span>
                            <span id="attendeeEmail" class="text-slate-800 text-sm"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 text-sm">Company</span>
                            <span id="attendeeCompany" class="text-slate-800"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 text-sm">Ticket Code</span>
                            <span id="ticketCode" class="font-mono font-bold text-emerald-600"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 text-sm">Status</span>
                            <span id="ticketStatus" class="px-3 py-1 rounded-full text-xs font-semibold"></span>
                        </div>
                        <div id="checkinTimeRow" class="flex justify-between items-center hidden">
                            <span class="text-slate-500 text-sm">Checked In</span>
                            <span id="checkinTime" class="text-slate-800 text-sm"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div id="actionButtons" class="space-y-3 hidden">
                <button id="checkinBtn" class="w-full bg-emerald-600 text-white font-semibold py-4 px-6 rounded-xl hover:bg-emerald-700 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Check In Attendee
                </button>
                <a href="/checkin" class="block w-full bg-slate-200 text-slate-700 font-semibold py-3 px-6 rounded-xl hover:bg-slate-300 transition-colors text-center">
                    Back to Check-In
                </a>
            </div>
            
            <!-- Error Actions -->
            <div id="errorActions" class="space-y-3 hidden">
                <a href="/checkin" class="block w-full bg-slate-800 text-white font-semibold py-4 px-6 rounded-xl hover:bg-slate-900 transition-colors text-center">
                    Go to Check-In Page
                </a>
            </div>
        </div>
    </div>

    <script>
        const STAFF_PIN = '2003';
        const ticketCode = '<%= ticketCode %>';
        
        // PIN Input handling
        const pinInputs = document.querySelectorAll('.pin-input');
        const verifyPinBtn = document.getElementById('verifyPinBtn');
        const pinError = document.getElementById('pinError');
        const pinContainer = document.getElementById('pinContainer');
        
        pinInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value.replace(/[^0-9]/g, '');
                e.target.value = value;
                
                if (value && index < pinInputs.length - 1) {
                    pinInputs[index + 1].focus();
                }
                
                checkPinComplete();
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    pinInputs[index - 1].focus();
                }
            });
            
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                const digits = paste.replace(/[^0-9]/g, '').slice(0, 4);
                
                digits.split('').forEach((digit, i) => {
                    if (pinInputs[i]) {
                        pinInputs[i].value = digit;
                    }
                });
                
                checkPinComplete();
            });
        });
        
        function checkPinComplete() {
            const pin = Array.from(pinInputs).map(i => i.value).join('');
            verifyPinBtn.disabled = pin.length !== 4;
        }
        
        function getEnteredPin() {
            return Array.from(pinInputs).map(i => i.value).join('');
        }
        
        verifyPinBtn.addEventListener('click', async () => {
            const enteredPin = getEnteredPin();
            
            if (enteredPin !== STAFF_PIN) {
                pinError.classList.remove('hidden');
                pinContainer.classList.add('shake');
                setTimeout(() => pinContainer.classList.remove('shake'), 500);
                
                // Clear inputs
                pinInputs.forEach(input => input.value = '');
                pinInputs[0].focus();
                verifyPinBtn.disabled = true;
                return;
            }
            
            // PIN correct - show verification
            pinError.classList.add('hidden');
            document.getElementById('pinScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            
            await verifyTicket();
        });
        
        async function verifyTicket() {
            const statusHeader = document.getElementById('statusHeader');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            const ticketDetails = document.getElementById('ticketDetails');
            const actionButtons = document.getElementById('actionButtons');
            const errorActions = document.getElementById('errorActions');
            const checkinBtn = document.getElementById('checkinBtn');
            
            try {
                // Show loading
                statusHeader.className = 'p-6 text-center bg-slate-50';
                statusIcon.innerHTML = '<div class="w-8 h-8 border-4 border-slate-300 border-t-slate-600 rounded-full animate-spin"></div>';
                statusIcon.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4';
                statusTitle.textContent = 'Verifying...';
                statusMessage.textContent = 'Checking ticket validity';
                
                const response = await fetch(`/api/tickets/verify/${ticketCode}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Ticket not found');
                }
                
                // Valid ticket
                const isCheckedIn = data.checked_in;
                
                if (isCheckedIn) {
                    // Already checked in
                    statusHeader.className = 'p-6 text-center bg-amber-50';
                    statusIcon.innerHTML = `<svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>`;
                    statusIcon.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 bg-amber-100';
                    statusTitle.textContent = 'Already Checked In';
                    statusTitle.className = 'text-2xl font-bold mb-1 text-amber-800';
                    statusMessage.textContent = 'This ticket has already been used';
                    statusMessage.className = 'text-sm text-amber-600';
                    
                    checkinBtn.classList.add('hidden');
                } else {
                    // Valid and not checked in
                    statusHeader.className = 'p-6 text-center bg-emerald-50';
                    statusIcon.innerHTML = `<svg class="w-10 h-10 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>`;
                    statusIcon.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 bg-emerald-100';
                    statusTitle.textContent = 'Valid Ticket';
                    statusTitle.className = 'text-2xl font-bold mb-1 text-emerald-800';
                    statusMessage.textContent = 'Ready for check-in';
                    statusMessage.className = 'text-sm text-emerald-600';
                    
                    checkinBtn.classList.remove('hidden');
                }
                
                // Show ticket details
                document.getElementById('attendeeName').textContent = data.full_name || '-';
                document.getElementById('attendeeEmail').textContent = data.email || '-';
                document.getElementById('attendeeCompany').textContent = data.company || data.firm_name || '-';
                document.getElementById('ticketCode').textContent = data.ticket_code;
                
                const ticketStatusEl = document.getElementById('ticketStatus');
                if (isCheckedIn) {
                    ticketStatusEl.textContent = 'Checked In';
                    ticketStatusEl.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700';
                    
                    if (data.checked_in_at) {
                        document.getElementById('checkinTimeRow').classList.remove('hidden');
                        document.getElementById('checkinTime').textContent = new Date(data.checked_in_at).toLocaleString();
                    }
                } else {
                    ticketStatusEl.textContent = 'Not Checked In';
                    ticketStatusEl.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700';
                }
                
                ticketDetails.classList.remove('hidden');
                actionButtons.classList.remove('hidden');
                
                // Check-in button handler
                checkinBtn.onclick = async () => {
                    checkinBtn.disabled = true;
                    checkinBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Checking in...';
                    
                    try {
                        const checkinResponse = await fetch('/api/tickets/checkin', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ticket_code: ticketCode })
                        });
                        
                        if (checkinResponse.ok) {
                            // Success
                            statusHeader.className = 'p-6 text-center bg-emerald-500';
                            statusIcon.innerHTML = `<svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>`;
                            statusIcon.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 bg-emerald-400';
                            statusTitle.textContent = 'Checked In!';
                            statusTitle.className = 'text-2xl font-bold mb-1 text-white';
                            statusMessage.textContent = 'Attendee has been checked in successfully';
                            statusMessage.className = 'text-sm text-emerald-100';
                            
                            checkinBtn.classList.add('hidden');
                            
                            ticketStatusEl.textContent = 'Checked In';
                            ticketStatusEl.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700';
                        } else {
                            const errData = await checkinResponse.json();
                            throw new Error(errData.detail || 'Check-in failed');
                        }
                    } catch (err) {
                        alert('Check-in failed: ' + err.message);
                        checkinBtn.disabled = false;
                        checkinBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg> Check In Attendee`;
                    }
                };
                
            } catch (err) {
                // Invalid ticket
                statusHeader.className = 'p-6 text-center bg-red-50';
                statusIcon.innerHTML = `<svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>`;
                statusIcon.className = 'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 bg-red-100';
                statusTitle.textContent = 'Invalid Ticket';
                statusTitle.className = 'text-2xl font-bold mb-1 text-red-800';
                statusMessage.textContent = err.message || 'This ticket code is not valid';
                statusMessage.className = 'text-sm text-red-600';
                
                errorActions.classList.remove('hidden');
            }
        }
        
        // Auto-focus first input
        pinInputs[0].focus();
    </script>
</body>
</html>
