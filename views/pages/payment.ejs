<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Payment | Ghana Competition Law Seminar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.4); opacity: 0; } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .pulse-ring { animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        .spin-slow { animation: spin-slow 3s linear infinite; }
        .slide-up { animation: slideUp 0.6s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen flex items-center justify-center p-4">
    
    <!-- Payment View - Horizontal Layout -->
    <div id="paymentView" class="max-w-4xl w-full slide-up">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
            <div class="grid grid-cols-1 md:grid-cols-2">
                <!-- Left: MTN MoMo -->
                <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-8 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-40 h-40 bg-yellow-400/10 rounded-full blur-3xl"></div>
                    <div class="relative flex flex-col h-full">
                        <div class="text-center mb-6">
                            <div class="flex items-center justify-center gap-2 mb-3">
                                <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>
                                <span class="text-xs text-emerald-400 font-medium">Secure Payment</span>
                            </div>
                            <h2 class="text-xl font-bold text-white">Pay with Mobile Money</h2>
                        </div>
                        <div class="flex justify-center mb-6">
                            <div class="bg-[#FFCC00] rounded-2xl p-4 shadow-lg">
                                <img src="/images/mtn-momo.png" alt="MTN MoMo" class="w-24 h-24 object-contain">
                            </div>
                        </div>
                        <div class="text-center mb-6">
                            <p class="font-bold text-white text-lg">MTN Mobile Money</p>
                            <p class="text-slate-400 text-sm">Ghana's trusted payment</p>
                        </div>
                        <div class="space-y-3 text-sm flex-grow">
                            <div class="flex justify-between items-center bg-white/5 rounded-xl px-4 py-3 border border-white/10">
                                <span class="text-slate-400">Merchant Code</span>
                                <span class="font-mono font-bold text-yellow-400 text-xl"><%= settings.merchant_code %></span>
                            </div>
                            <div class="flex justify-between items-center bg-white/5 rounded-xl px-4 py-3 border border-white/10">
                                <span class="text-slate-400">Merchant Name</span>
                                <span class="font-semibold text-white"><%= settings.merchant_name %></span>
                            </div>
                            <div class="flex justify-between items-center bg-white/5 rounded-xl px-4 py-3 border border-white/10">
                                <span class="text-slate-400">Amount</span>
                                <span class="font-bold text-yellow-400 text-lg">GHS <%= settings.ticket_price %>.00</span>
                            </div>
                            <div class="flex justify-between items-center bg-white/5 rounded-xl px-4 py-3 border border-white/10">
                                <span class="text-slate-400">Reference</span>
                                <span class="font-mono text-white bg-slate-700 px-2 py-0.5 rounded text-xs">REG-<%= registration.id %></span>
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t border-white/10 text-center">
                            <p class="text-sm text-slate-300"><span class="text-yellow-400 font-semibold">Dial *170#</span> â†’ Pay Merchant</p>
                            <p class="text-xs text-slate-500 mt-1">or use MTN MoMo App</p>
                        </div>
                    </div>
                </div>
                <!-- Right: Summary -->
                <div class="p-8 flex flex-col">
                    <div class="text-center mb-6 pb-6 border-b border-slate-100">
                        <img src="https://ik.imagekit.io/dr5fryhth/conference/imglogo?updatedAt=1769778325875" alt="Logo" class="h-12 mx-auto mb-3">
                        <h1 class="text-lg font-bold text-slate-900">Ghana Competition Law Seminar</h1>
                        <p class="text-slate-500 text-xs">Registration Payment</p>
                    </div>
                    <div class="space-y-4 text-sm flex-grow">
                        <div><p class="text-slate-400 text-xs uppercase mb-1">Attendee</p><p class="font-semibold text-slate-900"><%= registration.fullName %></p></div>
                        <div><p class="text-slate-400 text-xs uppercase mb-1">Email</p><p class="font-medium text-slate-700 text-sm"><%= registration.email %></p></div>
                        <% if (registration.firmName) { %><div><p class="text-slate-400 text-xs uppercase mb-1">Organization</p><p class="font-medium text-slate-900"><%= registration.firmName %></p></div><% } %>
                    </div>
                    <div class="border-t border-slate-100 my-4"></div>
                    <div class="flex justify-between items-center mb-6">
                        <span class="font-semibold text-slate-700">Total</span>
                        <span class="text-3xl font-bold text-slate-900">GHS <%= settings.ticket_price %>.00</span>
                    </div>
                    <button id="confirmPaymentBtn" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-slate-900 font-bold py-4 px-6 rounded-xl transition-all flex items-center justify-center gap-3 shadow-lg hover:scale-[1.02] active:scale-[0.98]">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span>I Have Made Payment</span>
                    </button>
                    <p class="text-xs text-center text-slate-400 mt-4">Click after completing MoMo payment</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending View - Horizontal Layout -->
    <div id="pendingView" class="max-w-4xl w-full hidden">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
            <div class="grid grid-cols-1 md:grid-cols-2">
                <!-- Left: Status -->
                <div class="flex flex-col items-center justify-center gap-6 p-10 text-center bg-gradient-to-br from-slate-50 to-white">
                    <div class="relative w-24 h-24">
                        <div class="absolute inset-0 rounded-full border-4 border-slate-100"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-transparent border-t-emerald-500 spin-slow"></div>
                        <div class="absolute inset-2 rounded-full bg-gradient-to-br from-emerald-50 to-white flex items-center justify-center">
                            <svg class="w-10 h-10 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <div class="absolute inset-0 rounded-full border-4 border-emerald-500/30 pulse-ring"></div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Payment Processing</h2>
                        <p class="text-slate-500 text-sm max-w-xs">Your payment is being verified. This usually takes a few minutes.</p>
                    </div>
                    <div class="w-full max-w-xs space-y-3">
                        <a href="/" class="block w-full bg-slate-900 hover:bg-slate-800 text-white font-semibold py-3.5 px-6 rounded-xl text-center">Return to Home</a>
                        <p class="text-xs text-slate-400">You can safely close this page</p>
                    </div>
                </div>
                <!-- Right: Summary -->
                <div class="p-8 border-l border-slate-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-slate-900">Payment Summary</h3>
                        <span class="px-3 py-1 bg-amber-100 text-amber-700 text-xs font-semibold rounded-full">Pending</span>
                    </div>
                    <div class="space-y-4 text-sm mb-6">
                        <div><p class="text-slate-400 text-xs uppercase mb-1">Attendee</p><p class="font-semibold text-slate-900"><%= registration.fullName %></p></div>
                        <div><p class="text-slate-400 text-xs uppercase mb-1">Email</p><p class="font-medium text-slate-700"><%= registration.email %></p></div>
                        <% if (registration.firmName) { %><div><p class="text-slate-400 text-xs uppercase mb-1">Organization</p><p class="font-medium text-slate-900"><%= registration.firmName %></p></div><% } %>
                    </div>
                    <div class="border-t border-slate-100 my-5"></div>
                    <div class="flex justify-between items-center mb-6">
                        <span class="font-semibold text-slate-700">Amount</span>
                        <span class="text-2xl font-bold text-slate-900">GHS <%= settings.ticket_price %>.00</span>
                    </div>
                    <div class="border-t border-slate-100 my-5"></div>
                    <h4 class="text-xs font-semibold text-slate-400 uppercase mb-4">What happens next?</h4>
                    <div class="space-y-3">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></div><div><p class="font-medium text-slate-900 text-sm">Email Confirmation</p><p class="text-xs text-slate-500">Ticket sent via email</p></div></div>
                        <div class="flex items-center gap-3"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg></div><div><p class="font-medium text-slate-900 text-sm">SMS Notification</p><p class="text-xs text-slate-500">Confirmation SMS sent</p></div></div>
                        <div class="flex items-center gap-3"><div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/></svg></div><div><p class="font-medium text-slate-900 text-sm">QR Code Ticket</p><p class="text-xs text-slate-500">Present at venue</p></div></div>
                    </div>
                    <div class="mt-6 p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <p class="text-xs text-slate-500 text-center"><span class="font-semibold text-slate-700">Note:</span> Off-hours payments may take longer. Your registration is secure.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const registrationId = '<%= registration.id %>';
        let pollingInterval = null;
        
        // Poll for payment verification status
        async function checkPaymentStatus() {
            try {
                const res = await fetch('/api/registration/' + registrationId + '/status');
                if (res.ok) {
                    const data = await res.json();
                    if (data.status === 'confirmed') {
                        // Payment verified! Redirect to success page with regId for QR code fetch
                        clearInterval(pollingInterval);
                        window.location.href = '/?payment=success&ticket=' + (data.ticket_code || '') + '&regId=' + registrationId;
                    }
                }
            } catch (err) {
                console.error('Error checking status:', err);
            }
        }
        
        document.getElementById('confirmPaymentBtn').addEventListener('click', async () => {
            const btn = document.getElementById('confirmPaymentBtn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Processing...</span>';
            try {
                await new Promise(r => setTimeout(r, 1500));
                const response = await fetch('/api/payment-submitted', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ registrationId }) 
                });
                
                if (!response.ok) {
                    throw new Error('Failed to submit payment: ' + response.status);
                }
                
                const result = await response.json();
                console.log('Payment submitted:', result);
                
                document.getElementById('paymentView').style.opacity = '0';
                document.getElementById('paymentView').style.transform = 'scale(0.95)';
                setTimeout(() => {
                    document.getElementById('paymentView').classList.add('hidden');
                    document.getElementById('pendingView').classList.remove('hidden');
                    document.getElementById('pendingView').classList.add('slide-up');
                    pollingInterval = setInterval(checkPaymentStatus, 3000);
                }, 300);
            } catch (err) {
                console.error('Payment submission error:', err);
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                btn.innerHTML = originalContent;
                alert('An error occurred. Please try again.');
            }
        });
    </script>
</body>
</html>